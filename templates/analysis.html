{% extends "layout.html" %}

{% block title %}Match Analysis - Tennis Match Analytics{% endblock %}

{% block head %}
<!-- Additional head content for analysis page -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
{% endblock %}

{% block content %}
<div id="match-data" data-match-id="{{ match.id }}">
    <!-- Analysis Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-1">{{ match.title }}</h1>
            <p class="text-muted">
                <i class="fas fa-calendar-alt me-1"></i> {{ match.date.strftime('%B %d, %Y') }}
                {% if match.opponent %}
                <span class="mx-2">|</span>
                <i class="fas fa-user me-1"></i> vs {{ match.opponent }}
                {% endif %}
                {% if match.location %}
                <span class="mx-2">|</span>
                <i class="fas fa-map-marker-alt me-1"></i> {{ match.location }}
                {% endif %}
            </p>
        </div>
        <div>
            <a href="{{ url_for('match.download_report', match_id=match.id) }}" class="btn btn-success me-2" target="_blank">
                <i class="fas fa-file-download me-1"></i>Download Full Report
            </a>
            <button class="btn btn-outline-primary share-match-btn me-2" data-match-id="{{ match.id }}">
                <i class="fas fa-share-alt me-1"></i>Share Analysis
            </button>
            <a href="{{ url_for('match.match_details', match_id=match.id) }}" class="btn btn-secondary">
                <i class="fas fa-info-circle me-1"></i>Match Details
            </a>
        </div>
    </div>
    
    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-4" id="analysisTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">
                <i class="fas fa-chart-pie me-1"></i>Overview
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="shots-tab" data-bs-toggle="tab" data-bs-target="#shots" type="button" role="tab" aria-controls="shots" aria-selected="false">
                <i class="fas fa-bullseye me-1"></i>Shot Analysis
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="technique-tab" data-bs-toggle="tab" data-bs-target="#technique" type="button" role="tab" aria-controls="technique" aria-selected="false">
                <i class="fas fa-running me-1"></i>Technique
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" type="button" role="tab" aria-controls="stats" aria-selected="false">
                <i class="fas fa-clipboard-list me-1"></i>Detailed Stats
            </button>
        </li>
    </ul>
    
    <!-- Tab Content -->
    <div class="tab-content" id="analysisTabContent">
        <!-- Overview Tab -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
            <div class="row">
                <!-- Basic Stats Card -->
                <div class="col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0">Basic Statistics</h5>
                        </div>
                        <div class="card-body">
                            <div class="stat-item">
                                <div class="stat-label">Aces</div>
                                <div class="stat-value">{{ statistics.basic_stats.aces }}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Double Faults</div>
                                <div class="stat-value">{{ statistics.basic_stats.double_faults }}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">First Serve %</div>
                                <div class="stat-value">{{ statistics.basic_stats.first_serve_percentage }}%</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">First Serve Points Won</div>
                                <div class="stat-value">{{ statistics.basic_stats.first_serve_points_won }}%</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Second Serve Points Won</div>
                                <div class="stat-value">{{ statistics.basic_stats.second_serve_points_won }}%</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Break Points Saved</div>
                                <div class="stat-value">{{ statistics.basic_stats.break_points_saved }}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Break Points Converted</div>
                                <div class="stat-value">{{ statistics.basic_stats.break_points_converted }}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Total Points Won</div>
                                <div class="stat-value">{{ statistics.basic_stats.total_points_won }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Performance Radar Chart -->
                <div class="col-lg-8 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0">Performance Overview</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="statsComparisonChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Shot Distribution -->
                <div class="col-lg-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0">Shot Distribution</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="shotDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Game Phases Analysis -->
                <div class="col-lg-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0">Stroke Phase Analysis</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="gamePhaseScoresChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Shot Analysis Tab -->
        <div class="tab-pane fade" id="shots" role="tabpanel" aria-labelledby="shots-tab">
            <div class="row">
                <!-- Shot Placement Chart -->
                <div class="col-lg-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0">Shot Placement</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="shotPlacementChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Serve Analysis -->
                <div class="col-lg-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0">Serve Analysis</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="serveAnalysisChart"></canvas>
                            </div>
                            <div class="mt-3">
                                <div class="stat-item">
                                    <div class="stat-label">Average Serve Speed</div>
                                    <div class="stat-value">{{ statistics.shot_analysis.serve.speed.avg }} mph</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">Max Serve Speed</div>
                                    <div class="stat-value">{{ statistics.shot_analysis.serve.speed.max }} mph</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Forehand Analysis -->
                <div class="col-lg-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0">Forehand Analysis</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-6">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h2 class="mb-0 text-success">{{ statistics.shot_analysis.forehand.winners }}</h2>
                                            <p class="mb-0">Winners</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h2 class="mb-0 text-danger">{{ statistics.shot_analysis.forehand.errors }}</h2>
                                            <p class="mb-0">Errors</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <h6>Placement Distribution</h6>
                                <div class="stat-item">
                                    <div class="stat-label">Cross Court</div>
                                    <div class="stat-value">{{ statistics.shot_analysis.forehand.placement.cross_court }}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">Down The Line</div>
                                    <div class="stat-value">{{ statistics.shot_analysis.forehand.placement.down_the_line }}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">Inside Out</div>
                                    <div class="stat-value">{{ statistics.shot_analysis.forehand.placement.inside_out }}</div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <h6>Speed</h6>
                                <div class="stat-item">
                                    <div class="stat-label">Average</div>
                                    <div class="stat-value">{{ statistics.shot_analysis.forehand.speed.avg }} mph</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">Maximum</div>
                                    <div class="stat-value">{{ statistics.shot_analysis.forehand.speed.max }} mph</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Backhand Analysis -->
                <div class="col-lg-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0">Backhand Analysis</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-6">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h2 class="mb-0 text-success">{{ statistics.shot_analysis.backhand.winners }}</h2>
                                            <p class="mb-0">Winners</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h2 class="mb-0 text-danger">{{ statistics.shot_analysis.backhand.errors }}</h2>
                                            <p class="mb-0">Errors</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <h6>Placement Distribution</h6>
                                <div class="stat-item">
                                    <div class="stat-label">Cross Court</div>
                                    <div class="stat-value">{{ statistics.shot_analysis.backhand.placement.cross_court }}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">Down The Line</div>
                                    <div class="stat-value">{{ statistics.shot_analysis.backhand.placement.down_the_line }}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">Inside Out</div>
                                    <div class="stat-value">{{ statistics.shot_analysis.backhand.placement.inside_out }}</div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <h6>Speed</h6>
                                <div class="stat-item">
                                    <div class="stat-label">Average</div>
                                    <div class="stat-value">{{ statistics.shot_analysis.backhand.speed.avg }} mph</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">Maximum</div>
                                    <div class="stat-value">{{ statistics.shot_analysis.backhand.speed.max }} mph</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Technique Tab -->
        <div class="tab-pane fade" id="technique" role="tabpanel" aria-labelledby="technique-tab">
            <div class="row">
                <!-- Player Movement Chart -->
                <div class="col-lg-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0">Player Movement</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="playerMovementChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Preparation Phase -->
                <div class="col-lg-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Preparation Phase</h5>
                            <span class="badge rounded-pill {% if statistics.game_phases.preparation.score >= 80 %}bg-success{% elif statistics.game_phases.preparation.score >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ statistics.game_phases.preparation.score }}/100
                            </span>
                        </div>
                        <div class="card-body">
                            <div class="stage-rating mb-3">
                                <div class="rating-label">Grip Position</div>
                                <div class="progress flex-grow-1">
                                    <div class="progress-bar {% if statistics.game_phases.preparation.grip_rating == 'Excellent' %}bg-success{% elif statistics.game_phases.preparation.grip_rating == 'Good' %}bg-warning{% else %}bg-danger{% endif %}" 
                                        role="progressbar" 
                                        style="width: {% if statistics.game_phases.preparation.grip_rating == 'Excellent' %}100%{% elif statistics.game_phases.preparation.grip_rating == 'Good' %}70%{% else %}40%{% endif %}" 
                                        aria-valuenow="{% if statistics.game_phases.preparation.grip_rating == 'Excellent' %}100{% elif statistics.game_phases.preparation.grip_rating == 'Good' %}70{% else %}40{% endif %}" 
                                        aria-valuemin="0" 
                                        aria-valuemax="100">
                                    </div>
                                </div>
                                <div class="rating-score {% if statistics.game_phases.preparation.grip_rating == 'Excellent' %}rating-excellent{% elif statistics.game_phases.preparation.grip_rating == 'Good' %}rating-good{% else %}rating-needs-improvement{% endif %}">
                                    {{ statistics.game_phases.preparation.grip_rating }}
                                </div>
                            </div>
                            <div class="stage-rating mb-3">
                                <div class="rating-label">Stance</div>
                                <div class="progress flex-grow-1">
                                    <div class="progress-bar {% if statistics.game_phases.preparation.stance_rating == 'Excellent' %}bg-success{% elif statistics.game_phases.preparation.stance_rating == 'Good' %}bg-warning{% else %}bg-danger{% endif %}" 
                                        role="progressbar" 
                                        style="width: {% if statistics.game_phases.preparation.stance_rating == 'Excellent' %}100%{% elif statistics.game_phases.preparation.stance_rating == 'Good' %}70%{% else %}40%{% endif %}" 
                                        aria-valuenow="{% if statistics.game_phases.preparation.stance_rating == 'Excellent' %}100{% elif statistics.game_phases.preparation.stance_rating == 'Good' %}70{% else %}40{% endif %}" 
                                        aria-valuemin="0" 
                                        aria-valuemax="100">
                                    </div>
                                </div>
                                <div class="rating-score {% if statistics.game_phases.preparation.stance_rating == 'Excellent' %}rating-excellent{% elif statistics.game_phases.preparation.stance_rating == 'Good' %}rating-good{% else %}rating-needs-improvement{% endif %}">
                                    {{ statistics.game_phases.preparation.stance_rating }}
                                </div>
                            </div>
                            <div class="stage-rating mb-3">
                                <div class="rating-label">Shoulder Rotation</div>
                                <div class="progress flex-grow-1">
                                    <div class="progress-bar {% if statistics.game_phases.preparation.shoulder_rotation == 'Excellent' %}bg-success{% elif statistics.game_phases.preparation.shoulder_rotation == 'Good' %}bg-warning{% else %}bg-danger{% endif %}" 
                                        role="progressbar" 
                                        style="width: {% if statistics.game_phases.preparation.shoulder_rotation == 'Excellent' %}100%{% elif statistics.game_phases.preparation.shoulder_rotation == 'Good' %}70%{% else %}40%{% endif %}" 
                                        aria-valuenow="{% if statistics.game_phases.preparation.shoulder_rotation == 'Excellent' %}100{% elif statistics.game_phases.preparation.shoulder_rotation == 'Good' %}70{% else %}40{% endif %}" 
                                        aria-valuemin="0" 
                                        aria-valuemax="100">
                                    </div>
                                </div>
                                <div class="rating-score {% if statistics.game_phases.preparation.shoulder_rotation == 'Excellent' %}rating-excellent{% elif statistics.game_phases.preparation.shoulder_rotation == 'Good' %}rating-good{% else %}rating-needs-improvement{% endif %}">
                                    {{ statistics.game_phases.preparation.shoulder_rotation }}
                                </div>
                            </div>
                            <div class="alert alert-primary mt-4">
                                <i class="fas fa-lightbulb me-2"></i>
                                <strong>Improvement tip:</strong> 
                                {% if statistics.game_phases.preparation.shoulder_rotation == 'Needs Improvement' %}
                                Work on your shoulder rotation during preparation. Try the shoulder turn drill: stand sideways to a wall, hold your racket, and practice rotating your shoulders while keeping your grip steady.
                                {% elif statistics.game_phases.preparation.stance_rating == 'Needs Improvement' %}
                                Focus on your stance width and balance. Practice the split-step to improve your ready position and balance.
                                {% elif statistics.game_phases.preparation.grip_rating == 'Needs Improvement' %}
                                Review your grip positioning. Work with continental grip for serves and volleys, and eastern or semi-western for ground strokes.
                                {% else %}
                                Your preparation phase looks solid! Continue to focus on consistency in your pre-shot routine.
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Contact & Follow Through -->
                <div class="col-12 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Stroke Execution Analysis</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="border-bottom pb-2 mb-3">Backswing Phase</h6>
                                    <div class="stage-rating mb-3">
                                        <div class="rating-label">Body Position</div>
                                        <div class="progress flex-grow-1">
                                            <div class="progress-bar {% if statistics.game_phases.backswing.body_position == 'Excellent' %}bg-success{% elif statistics.game_phases.backswing.body_position == 'Good' %}bg-warning{% else %}bg-danger{% endif %}" 
                                                role="progressbar" 
                                                style="width: {% if statistics.game_phases.backswing.body_position == 'Excellent' %}100%{% elif statistics.game_phases.backswing.body_position == 'Good' %}70%{% else %}40%{% endif %}" 
                                                aria-valuenow="{% if statistics.game_phases.backswing.body_position == 'Excellent' %}100{% elif statistics.game_phases.backswing.body_position == 'Good' %}70{% else %}40{% endif %}" 
                                                aria-valuemin="0" 
                                                aria-valuemax="100">
                                            </div>
                                        </div>
                                        <div class="rating-score {% if statistics.game_phases.backswing.body_position == 'Excellent' %}rating-excellent{% elif statistics.game_phases.backswing.body_position == 'Good' %}rating-good{% else %}rating-needs-improvement{% endif %}">
                                            {{ statistics.game_phases.backswing.body_position }}
                                        </div>
                                    </div>
                                    <div class="stage-rating mb-3">
                                        <div class="rating-label">Racket Path</div>
                                        <div class="progress flex-grow-1">
                                            <div class="progress-bar {% if statistics.game_phases.backswing.racket_path == 'Excellent' %}bg-success{% elif statistics.game_phases.backswing.racket_path == 'Good' %}bg-warning{% else %}bg-danger{% endif %}" 
                                                role="progressbar" 
                                                style="width: {% if statistics.game_phases.backswing.racket_path == 'Excellent' %}100%{% elif statistics.game_phases.backswing.racket_path == 'Good' %}70%{% else %}40%{% endif %}" 
                                                aria-valuenow="{% if statistics.game_phases.backswing.racket_path == 'Excellent' %}100{% elif statistics.game_phases.backswing.racket_path == 'Good' %}70{% else %}40{% endif %}" 
                                                aria-valuemin="0" 
                                                aria-valuemax="100">
                                            </div>
                                        </div>
                                        <div class="rating-score {% if statistics.game_phases.backswing.racket_path == 'Excellent' %}rating-excellent{% elif statistics.game_phases.backswing.racket_path == 'Good' %}rating-good{% else %}rating-needs-improvement{% endif %}">
                                            {{ statistics.game_phases.backswing.racket_path }}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="border-bottom pb-2 mb-3">Contact Phase</h6>
                                    <div class="stage-rating mb-3">
                                        <div class="rating-label">Timing</div>
                                        <div class="progress flex-grow-1">
                                            <div class="progress-bar {% if statistics.game_phases.contact.timing == 'Excellent' %}bg-success{% elif statistics.game_phases.contact.timing == 'Good' %}bg-warning{% else %}bg-danger{% endif %}" 
                                                role="progressbar" 
                                                style="width: {% if statistics.game_phases.contact.timing == 'Excellent' %}100%{% elif statistics.game_phases.contact.timing == 'Good' %}70%{% else %}40%{% endif %}" 
                                                aria-valuenow="{% if statistics.game_phases.contact.timing == 'Excellent' %}100{% elif statistics.game_phases.contact.timing == 'Good' %}70{% else %}40{% endif %}" 
                                                aria-valuemin="0" 
                                                aria-valuemax="100">
                                            </div>
                                        </div>
                                        <div class="rating-score {% if statistics.game_phases.contact.timing == 'Excellent' %}rating-excellent{% elif statistics.game_phases.contact.timing == 'Good' %}rating-good{% else %}rating-needs-improvement{% endif %}">
                                            {{ statistics.game_phases.contact.timing }}
                                        </div>
                                    </div>
                                    <div class="stage-rating mb-3">
                                        <div class="rating-label">Accuracy</div>
                                        <div class="progress flex-grow-1">
                                            <div class="progress-bar {% if statistics.game_phases.contact.accuracy == 'Excellent' %}bg-success{% elif statistics.game_phases.contact.accuracy == 'Good' %}bg-warning{% else %}bg-danger{% endif %}" 
                                                role="progressbar" 
                                                style="width: {% if statistics.game_phases.contact.accuracy == 'Excellent' %}100%{% elif statistics.game_phases.contact.accuracy == 'Good' %}70%{% else %}40%{% endif %}" 
                                                aria-valuenow="{% if statistics.game_phases.contact.accuracy == 'Excellent' %}100{% elif statistics.game_phases.contact.accuracy == 'Good' %}70{% else %}40{% endif %}" 
                                                aria-valuemin="0" 
                                                aria-valuemax="100">
                                            </div>
                                        </div>
                                        <div class="rating-score {% if statistics.game_phases.contact.accuracy == 'Excellent' %}rating-excellent{% elif statistics.game_phases.contact.accuracy == 'Good' %}rating-good{% else %}rating-needs-improvement{% endif %}">
                                            {{ statistics.game_phases.contact.accuracy }}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12 mt-3">
                                    <h6 class="border-bottom pb-2 mb-3">Follow Through Phase</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="stage-rating mb-3">
                                                <div class="rating-label">Completion</div>
                                                <div class="progress flex-grow-1">
                                                    <div class="progress-bar {% if statistics.game_phases.follow_through.completion == 'Excellent' %}bg-success{% elif statistics.game_phases.follow_through.completion == 'Good' %}bg-warning{% else %}bg-danger{% endif %}" 
                                                        role="progressbar" 
                                                        style="width: {% if statistics.game_phases.follow_through.completion == 'Excellent' %}100%{% elif statistics.game_phases.follow_through.completion == 'Good' %}70%{% else %}40%{% endif %}" 
                                                        aria-valuenow="{% if statistics.game_phases.follow_through.completion == 'Excellent' %}100{% elif statistics.game_phases.follow_through.completion == 'Good' %}70{% else %}40{% endif %}" 
                                                        aria-valuemin="0" 
                                                        aria-valuemax="100">
                                                    </div>
                                                </div>
                                                <div class="rating-score {% if statistics.game_phases.follow_through.completion == 'Excellent' %}rating-excellent{% elif statistics.game_phases.follow_through.completion == 'Good' %}rating-good{% else %}rating-needs-improvement{% endif %}">
                                                    {{ statistics.game_phases.follow_through.completion }}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="stage-rating mb-3">
                                                <div class="rating-label">Balance</div>
                                                <div class="progress flex-grow-1">
                                                    <div class="progress-bar {% if statistics.game_phases.follow_through.balance == 'Excellent' %}bg-success{% elif statistics.game_phases.follow_through.balance == 'Good' %}bg-warning{% else %}bg-danger{% endif %}" 
                                                        role="progressbar" 
                                                        style="width: {% if statistics.game_phases.follow_through.balance == 'Excellent' %}100%{% elif statistics.game_phases.follow_through.balance == 'Good' %}70%{% else %}40%{% endif %}" 
                                                        aria-valuenow="{% if statistics.game_phases.follow_through.balance == 'Excellent' %}100{% elif statistics.game_phases.follow_through.balance == 'Good' %}70{% else %}40{% endif %}" 
                                                        aria-valuemin="0" 
                                                        aria-valuemax="100">
                                                    </div>
                                                </div>
                                                <div class="rating-score {% if statistics.game_phases.follow_through.balance == 'Excellent' %}rating-excellent{% elif statistics.game_phases.follow_through.balance == 'Good' %}rating-good{% else %}rating-needs-improvement{% endif %}">
                                                    {{ statistics.game_phases.follow_through.balance }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Detailed Stats Tab -->
        <div class="tab-pane fade" id="stats" role="tabpanel" aria-labelledby="stats-tab">
            <div class="row">
                <div class="col-12 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Complete Statistics</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Statistic</th>
                                            <th class="text-end">Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="2" class="table-primary">Serve</td>
                                        </tr>
                                        <tr>
                                            <td>Aces</td>
                                            <td class="text-end">{{ statistics.basic_stats.aces }}</td>
                                        </tr>
                                        <tr>
                                            <td>Double Faults</td>
                                            <td class="text-end">{{ statistics.basic_stats.double_faults }}</td>
                                        </tr>
                                        <tr>
                                            <td>First Serve Percentage</td>
                                            <td class="text-end">{{ statistics.basic_stats.first_serve_percentage }}%</td>
                                        </tr>
                                        <tr>
                                            <td>First Serve Points Won</td>
                                            <td class="text-end">{{ statistics.basic_stats.first_serve_points_won }}%</td>
                                        </tr>
                                        <tr>
                                            <td>Second Serve Points Won</td>
                                            <td class="text-end">{{ statistics.basic_stats.second_serve_points_won }}%</td>
                                        </tr>
                                        <tr>
                                            <td>Average Serve Speed</td>
                                            <td class="text-end">{{ statistics.shot_analysis.serve.speed.avg }} mph</td>
                                        </tr>
                                        <tr>
                                            <td>Maximum Serve Speed</td>
                                            <td class="text-end">{{ statistics.shot_analysis.serve.speed.max }} mph</td>
                                        </tr>
                                        <tr>
                                            <td>Minimum Serve Speed</td>
                                            <td class="text-end">{{ statistics.shot_analysis.serve.speed.min }} mph</td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" class="table-primary">Forehand</td>
                                        </tr>
                                        <tr>
                                            <td>Winners</td>
                                            <td class="text-end">{{ statistics.shot_analysis.forehand.winners }}</td>
                                        </tr>
                                        <tr>
                                            <td>Errors</td>
                                            <td class="text-end">{{ statistics.shot_analysis.forehand.errors }}</td>
                                        </tr>
                                        <tr>
                                            <td>Cross Court Shots</td>
                                            <td class="text-end">{{ statistics.shot_analysis.forehand.placement.cross_court }}</td>
                                        </tr>
                                        <tr>
                                            <td>Down The Line Shots</td>
                                            <td class="text-end">{{ statistics.shot_analysis.forehand.placement.down_the_line }}</td>
                                        </tr>
                                        <tr>
                                            <td>Inside Out Shots</td>
                                            <td class="text-end">{{ statistics.shot_analysis.forehand.placement.inside_out }}</td>
                                        </tr>
                                        <tr>
                                            <td>Average Speed</td>
                                            <td class="text-end">{{ statistics.shot_analysis.forehand.speed.avg }} mph</td>
                                        </tr>
                                        <tr>
                                            <td>Maximum Speed</td>
                                            <td class="text-end">{{ statistics.shot_analysis.forehand.speed.max }} mph</td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" class="table-primary">Backhand</td>
                                        </tr>
                                        <tr>
                                            <td>Winners</td>
                                            <td class="text-end">{{ statistics.shot_analysis.backhand.winners }}</td>
                                        </tr>
                                        <tr>
                                            <td>Errors</td>
                                            <td class="text-end">{{ statistics.shot_analysis.backhand.errors }}</td>
                                        </tr>
                                        <tr>
                                            <td>Cross Court Shots</td>
                                            <td class="text-end">{{ statistics.shot_analysis.backhand.placement.cross_court }}</td>
                                        </tr>
                                        <tr>
                                            <td>Down The Line Shots</td>
                                            <td class="text-end">{{ statistics.shot_analysis.backhand.placement.down_the_line }}</td>
                                        </tr>
                                        <tr>
                                            <td>Inside Out Shots</td>
                                            <td class="text-end">{{ statistics.shot_analysis.backhand.placement.inside_out }}</td>
                                        </tr>
                                        <tr>
                                            <td>Average Speed</td>
                                            <td class="text-end">{{ statistics.shot_analysis.backhand.speed.avg }} mph</td>
                                        </tr>
                                        <tr>
                                            <td>Maximum Speed</td>
                                            <td class="text-end">{{ statistics.shot_analysis.backhand.speed.max }} mph</td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" class="table-primary">Volley</td>
                                        </tr>
                                        <tr>
                                            <td>Winners</td>
                                            <td class="text-end">{{ statistics.shot_analysis.volley.winners }}</td>
                                        </tr>
                                        <tr>
                                            <td>Errors</td>
                                            <td class="text-end">{{ statistics.shot_analysis.volley.errors }}</td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" class="table-primary">Movement</td>
                                        </tr>
                                        <tr>
                                            <td>Distance Covered</td>
                                            <td class="text-end">{{ statistics.player_movement.distance_covered }} m</td>
                                        </tr>
                                        <tr>
                                            <td>Sprints</td>
                                            <td class="text-end">{{ statistics.player_movement.sprints }}</td>
                                        </tr>
                                        <tr>
                                            <td>Direction Changes</td>
                                            <td class="text-end">{{ statistics.player_movement.direction_changes }}</td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" class="table-primary">Other</td>
                                        </tr>
                                        <tr>
                                            <td>Break Points Saved</td>
                                            <td class="text-end">{{ statistics.basic_stats.break_points_saved }}</td>
                                        </tr>
                                        <tr>
                                            <td>Break Points Converted</td>
                                            <td class="text-end">{{ statistics.basic_stats.break_points_converted }}</td>
                                        </tr>
                                        <tr>
                                            <td>Total Points Won</td>
                                            <td class="text-end">{{ statistics.basic_stats.total_points_won }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI Recommendation -->
    <div class="card mt-4 mb-5">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-robot me-2"></i>AI Improvement Recommendation</h5>
            <button id="analyzeBtn" class="btn btn-light btn-sm">
                <i class="fas fa-sync-alt me-1"></i>Get AI Analysis
            </button>
        </div>
        <div class="card-body">
            <div id="aiAnalysisContent">
                <!-- Analysis will show up here -->
                <div class="text-center text-muted">
                    <i class="fas fa-robot fa-2x mb-3"></i>
                    <p>Click the "Get AI Analysis" button to receive personalized improvement recommendations.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const analyzeBtn = document.getElementById('analyzeBtn');
    const analysisContent = document.getElementById('aiAnalysisContent');
    
    // Load animation
    const loadingHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h5 class="text-primary">Analyzing Your Match Data</h5>
            <p class="text-muted">This may take a few moments...</p>
        </div>
    `;

    // Show error message 
    const errorHTML = (message) => `
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong>Error:</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;

    // Structure analysis content
    function formatAnalysis(analysis) {
        const sections = analysis.split('\n\n');
        let html = '';
        
        sections.forEach(section => {
            if (section.trim()) {
                const sectionType = section.split('\n')[0].trim();
                const content = section.replace(sectionType, '').trim();
                
                switch(sectionType) {
                    case '[MATCH_SUMMARY]':
                        html += createSectionCard('Match Summary', 'chart-line', 'primary', content, 'lead');
                        break;
                    case '[KEY_AREAS]':
                        html += createSectionCard('Key Areas for Improvement', 'bullseye', 'warning', formatKeyAreas(content));
                        break;
                    case '[PRACTICE_DRILLS]':
                        html += createSectionCard('Practice Drills', 'dumbbell', 'success', formatPracticeDrills(content));
                        break;
                    case '[TECHNICAL_TIPS]':
                        html += createSectionCard('Technical Tips', 'lightbulb', 'info', formatTechnicalTips(content));
                        break;
                    case '[WEEKLY_PLAN]':
                        html += createSectionCard('Weekly Practice Plan', 'calendar-alt', 'secondary', formatWeeklyPlan(content));
                        break;
                }
            }
        });
        
        return html;
    }

    // Create section card
    function createSectionCard(title, icon, color, content, contentClass = '') {
        return `
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-${color} text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-${icon} me-2"></i>${title}
                    </h5>
                </div>
                <div class="card-body ${contentClass}">
                    ${content}
                </div>
            </div>
        `;
    }

    function formatKeyAreas(content) {
        const areas = content.split('\n\n');
        let html = '<div class="row g-3">';
        
        areas.forEach(area => {
            if (area.trim()) {
                const lines = area.split('\n');
                const title = lines[0].replace(/^\d+\.\s*/, '');
                const performance = lines[1]?.replace('- Current Performance:', '').trim();
                const impact = lines[2]?.replace('- Impact:', '').trim();
                const priority = lines[3]?.replace('- Priority:', '').trim();
                
                html += `
                    <div class="col-md-6">
                        <div class="card h-100 border-${getPriorityColor(priority)}">
                            <div class="card-body">
                                <h6 class="card-title d-flex justify-content-between align-items-center">
                                    ${title}
                                    <span class="badge bg-${getPriorityColor(priority)}">${priority}</span>
                                </h6>
                                <div class="card-text">
                                    <p class="mb-2"><strong>Current Performance:</strong> ${performance}</p>
                                    <p class="mb-0"><strong>Impact:</strong> ${impact}</p>
                                </div>
                            </div>
                        </div>
                    </div>`;
            }
        });
        
        html += '</div>';
        return html;
    }

    // Format the drills
    function formatPracticeDrills(content) {
        const drills = content.split('\n\n');
        let html = '<div class="row g-3">';
        
        drills.forEach(drill => {
            if (drill.trim()) {
                const lines = drill.split('\n');
                const title = lines[0].replace(/^\d+\.\s*/, '');
                const purpose = lines[1]?.replace('- Purpose:', '').trim();
                const steps = lines[2]?.replace('- Steps:', '').trim();
                const duration = lines[3]?.replace('- Duration:', '').trim();
                
                html += `
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">${title}</h6>
                                <div class="card-text">
                                    <p class="mb-2"><strong>Purpose:</strong> ${purpose}</p>
                                    <p class="mb-2"><strong>Steps:</strong></p>
                                    <ol class="mb-2">
                                        ${steps.split(',').map(step => `<li>${step.trim()}</li>`).join('')}
                                    </ol>
                                    <p class="mb-0"><strong>Duration:</strong> ${duration}</p>
                                </div>
                            </div>
                        </div>
                    </div>`;
            }
        });
        
        html += '</div>';
        return html;
    }

    // Format the tip display
    function formatTechnicalTips(content) {
        const tips = content.split('\n\n');
        let html = '<div class="row g-3">';
        
        tips.forEach(tip => {
            if (tip.trim()) {
                const lines = tip.split('\n');
                const category = lines[0].replace(/^\d+\.\s*/, '');
                const specificTip = lines[1]?.replace('- Specific Tip:', '').trim();
                const implementation = lines[2]?.replace('- Implementation:', '').trim();
                const outcome = lines[3]?.replace('- Expected Outcome:', '').trim();
                
                html += `
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">${category}</h6>
                                <div class="card-text">
                                    <p class="mb-2">${specificTip}</p>
                                    <p class="mb-2"><strong>Implementation:</strong> ${implementation}</p>
                                    <p class="mb-0"><strong>Expected Outcome:</strong> ${outcome}</p>
                                </div>
                            </div>
                        </div>
                    </div>`;
            }
        });
        
        html += '</div>';
        return html;
    }

    function formatWeeklyPlan(content) {
        const days = content.split('\n\n');
        let html = '<div class="row g-3">';
        
        days.forEach(day => {
            if (day.trim()) {
                const lines = day.split('\n');
                const dayTitle = lines[0];
                const activities = lines.slice(1).join('<br>');
                
                html += `
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="mb-0">${dayTitle}</h6>
                            </div>
                            <div class="card-body">
                                <p class="card-text">${activities}</p>
                            </div>
                        </div>
                    </div>`;
            }
        });
        
        html += '</div>';
        return html;
    }

    function getPriorityColor(priority) {
        switch(priority?.toLowerCase()) {
            case 'high':
                return 'danger';
            case 'medium':
                return 'warning';
            case 'low':
                return 'success';
            default:
                return 'secondary';
        }
    }

    // 
    analyzeBtn.addEventListener('click', async function() {
        try {
            // Display the loading animation
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Analyzing...';
            analysisContent.innerHTML = loadingHTML;
            
            // send POST request to the server
            const response = await fetch(`/match/{{ match.id }}/analyze`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Display formatted analysis
                const formattedAnalysis = formatAnalysis(data.analysis);
                analysisContent.innerHTML = formattedAnalysis;
            } else {
                throw new Error(data.error || 'Analysis failed');
            }
        } catch (error) {
            analysisContent.innerHTML = errorHTML(error.message);
        } finally {
            // Restore the button state
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Get AI Analysis';
        }
    });
});
</script>

<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
{% endblock %}
